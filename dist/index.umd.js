!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).webtracing=t()}(this,function(){"use strict";var d=function(){return(d=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function o(e,a,s,c){return new(s=s||Promise)(function(n,t){function r(e){try{i(c.next(e))}catch(e){t(e)}}function o(e){try{i(c.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?n(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(r,o)}i((c=c.apply(e,a||[])).next())})}function v(r,o){var i,a,s,c={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},u={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(u[Symbol.iterator]=function(){return this}),u;function e(n){return function(e){var t=[n,e];if(i)throw new TypeError("Generator is already executing.");for(;c=u&&t[u=0]?0:c;)try{if(i=1,a&&(s=2&t[0]?a.return:t[0]?a.throw||((s=a.return)&&s.call(a),0):a.next)&&!(s=s.call(a,t[1])).done)return s;switch(a=0,(t=s?[2&t[0],s.value]:t)[0]){case 0:case 1:s=t;break;case 4:return c.label++,{value:t[1],done:!1};case 5:c.label++,a=t[1],t=[0];continue;case 7:t=c.ops.pop(),c.trys.pop();continue;default:if(!(s=0<(s=c.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){c=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3]))c.label=t[1];else if(6===t[0]&&c.label<s[1])c.label=s[1],s=t;else{if(!(s&&c.label<s[2])){s[2]&&c.ops.pop(),c.trys.pop();continue}c.label=s[2],c.ops.push(t)}}t=o.call(r,c)}catch(e){t=[6,e],a=0}finally{i=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}}function r(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return{value:(e=e&&r>=e.length?void 0:e)&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function a(e,t,n){if(n||2===arguments.length)for(var r,o=0,i=t.length;o<i;o++)!r&&o in t||((r=r||Array.prototype.slice.call(t,0,o))[o]=t[o]);return e.concat(r||Array.prototype.slice.call(t))}function y(a){var e,t;if(Symbol.asyncIterator)return(e=a[Symbol.asyncIterator])?e.call(a):(a=r(a),t={},n("next"),n("throw"),n("return"),t[Symbol.asyncIterator]=function(){return this},t);throw new TypeError("Symbol.asyncIterator is not defined.");function n(i){t[i]=a[i]&&function(o){return new Promise(function(e,t){var n,r;o=a[i](o),n=e,e=t,r=o.done,t=o.value,Promise.resolve(t).then(function(e){n({value:e,done:r})},e)})}}}function e(){this.events={}}e.prototype.on=function(e,t,n,r){this.events||(this.events={}),!this.events[e]||n?this.events[e]=[t]:r?this.events[e].unshift(t):this.events[e].push(t)},e.prototype.emit=function(e){for(var t=this,n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];this.events[e]&&this.events[e].forEach(function(e){return e.call.apply(e,a([t],n,!1))})},e.prototype.once=function(r,o){var i=this;i.on(r,function e(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];o.call.apply(o,a([this],t,!1)),i.off(r,e)})},e.prototype.off=function(e,t){this.events[e]&&(t=this.events[e].indexOf(t),this.events[e].splice(t,1))};var m=new e;function i(n){return Object.keys(n).forEach(function(e){var t=n[e];"number"==typeof t&&(n[e]=0===t?void 0:parseFloat(t.toFixed(2)))}),n}function t(){return(new Date).getTime()}var s=Array.prototype.map||function(e){for(var t=[],n=0;n<this.length;n+=1)t.push(e(this[n],n,this));return t};var c=navigator.sendBeacon?function(e,t){t&&navigator.sendBeacon(e,JSON.stringify(t))}:function(e,t){(new Image).src="".concat(e,"?v=").concat(encodeURIComponent(JSON.stringify(t)))},u=window.requestIdleCallback||window.requestAnimationFrame||function(e){return setTimeout(e,17)},f=5,n=5e3,l={performance:!!window.performance,getEntriesByType:!(!window.performance||!performance.getEntriesByType),PerformanceObserver:"PerformanceObserver"in window,MutationObserver:"MutationObserver"in window,PerformanceNavigationTiming:"PerformanceNavigationTiming"in window},p=t(),h="",g=[],w=null,b={pageId:p,appName:""};function T(e,t){void 0===t&&(t=!1),g=g.concat(e),clearTimeout(w),g.length>=f||t?S():w=setTimeout(function(){S()},n)}function S(){var e,t,n;g.length&&(e=g.slice(0,f),g=g.slice(f),function(){for(var e=0;e<arguments.length;e++)e,0}("send events",e),t=Date.now(),console.log("===2",h),c(h,{baseInfo:d(d({},b),{sendTime:t}),eventInfo:(n=function(e){if(e.sendTime=t,"click"===e.eventType||"scroll"===e.eventType||"submit"===e.eventType||"change"===e.eventType)e.type="mix";else if("performance"===e.eventType)switch(e.eventId){case"resource":e.type="resourcePerformance";break;case"page":e.type="pagePerformance";break;case"server":e.type="serverPerformance"}else e.type=e.eventType;return e},s.call(e,n))}),g.length)&&u(S)}var E=function(e){var t=e.appName,e=e.requestUrl;h=e,b.appName=t},O=function(e){e.pv&&T({type:"behavior",subType:"pv",uuid:t(),data:{url:window.location.href,refer:document.referrer,action:window.performance.navigation.type,size:"".concat(window.screen.width,"*").concat(window.screen.height),title:e.title||document.title}})};var P={init:function(e){e.eventCore}};function x(e,t){e="observer"===e?t:{firstPaint:t["first-paint"].startTime,firstContentfulPaint:t["first-contentful-paint"].startTime,sslLinkTimes:t.navigation.connectEnd-t.navigation.secureConnectionStart,redirectTimes:t.navigation.redirectEnd-t.navigation.redirectStart,unLoadTime:t.navigation.unloadEventEnd-t.navigation.unloadEventStart};T({type:"performance",subType:"document",data:i(d({},e)),uuid:p})}var k={init:function(e){var t,n,r=e.performanceFirstResource,e=e.performanceCore;(r||e)&&(l.PerformanceObserver?function(t,f,l){var n=this,p={};return new Promise(function(u,e){new PerformanceObserver(function(c){return o(n,void 0,void 0,function(){var t,n,r,o,i,a,s;return v(this,function(e){switch(e.label){case 0:e.trys.push([0,5,6,11]),t=!0,n=y(c.getEntries()),e.label=1;case 1:return[4,n.next()];case 2:if(s=e.sent(),o=s.done)return[3,4];s=s.value,t=!1;try{"navigation"===(r=s).entryType?p[r.entryType]=d({},r.toJSON()):"resource"===r.entryType?"xmlhttprequest"===r.initiatorType&&r.name.includes("api/")&&(p.resource=p.resource||{},p.resource[r.name]=d({},r.toJSON())):p[r.name]={name:r.name,entryType:r.entryType,startTime:r.startTime,duration:r.duration}}finally{t=!0}e.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return s=e.sent(),i={error:s},[3,11];case 6:return e.trys.push([6,,9,10]),t||o||!(a=n.return)?[3,8]:[4,a.call(n)];case 7:e.sent(),e.label=8;case 8:return[3,10];case 9:if(i)throw i.error;return[7];case 10:return[7];case 11:return u(p),a=l,f&&p[f]&&JSON.stringify(a)!==JSON.stringify(p[f])&&(a=d({},p[f]),console.log("---343245",p[f]),m.emit(f,p[f])),[2]}})})}).observe(t)})}({entryTypes:["paint","navigation"]}).then(function(e){x("observer",e)}):(r={fmp:0},e=window.performance,n=e.timing,l.getEntriesByType&&((t=e.getEntriesByType("paint")).length&&(r.fmp=t[t.length-1].startTime),l.PerformanceNavigationTiming)&&(t=e.getEntriesByType("navigation")[0])&&(n=t),r.fpt=n.responseEnd-n.fetchStart,r.tti=n.domInteractive-n.fetchStart,r.ready=n.domContentLoadedEventEnd-n.fetchStart,r.loadon=n.loadEventStart-n.fetchStart,r.firstbyte=n.responseStart-n.domainLookupStart,r.dns=n.domainLookupEnd-n.domainLookupStart,r.appcache=n.domainLookupStart-n.fetchStart,r.tcp=n.connectEnd-n.connectStart,r.ttfb=n.responseStart-n.requestStart,r.trans=n.responseEnd-n.responseStart,r.dom=n.domInteractive-n.responseEnd,r.res=n.loadEventStart-n.domContentLoadedEventEnd,r.ssllink=n.connectEnd-n.secureConnectionStart,r.redirect=n.redirectEnd-n.redirectStart,r.unloadTime=n.unloadEventEnd-n.unloadEventStart,x("calc",r)))}},I=function(t){void 0===t&&(t={});var n=this;["src","method","duration","responseStatus"].forEach(function(e){n[e]=t[e]||null})};function L(e,t){var n,r={};"server"===e?r=t:(n=Date.now(),Object.keys(t).forEach(function(e){r[e]={triggerTime:n,url:window.location.href,apiTimes:t[e].startTime,durationTimes:t[e].duration,responseEndTime:t[e].responseEnd}})),T({type:"performance",subType:"resourceApi",uuid:p,triggerTime:Date.now(),data:i(r)})}var N={init:function(e){var t,i,n=e.performanceServer,e=e.errorServer;(n||e)&&(t=XMLHttpRequest.prototype.send,i=new I,XMLHttpRequest.prototype.send=function(r){var o=this;return console.log("=========3",r),this.addEventListener("readystatechange",function(){var e=o.readyState,t=o.status,n=o.responseURL,n=void 0===n?i.src:n;o.responseText;4===e&&L("server",{url:n,responseStatus:t,duration:Date.now()-i.triggerTime,params:r||void 0})}),i.triggerTime=Date.now(),t.call(this,r)})}};return{init:function(e){E(e),O(e),P.init(e),k.init(e),N.init(e)}}});
